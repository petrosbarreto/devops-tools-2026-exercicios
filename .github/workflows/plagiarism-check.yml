name: Detector de Pl√°gio

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  check-plagiarism:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Instalar depend√™ncias
        run: pip install difflib
      
      - name: Detectar similaridade entre c√≥digos
        id: plagiarism-check
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import difflib
          import re
          from pathlib import Path
          
          def normalize_code(code):
              """Remove espa√ßos, coment√°rios e normaliza c√≥digo"""
              # Remove coment√°rios HTML
              code = re.sub(r'<!--.*?-->', '', code, flags=re.DOTALL)
              # Remove coment√°rios JS
              code = re.sub(r'//.*?$', '', code, flags=re.MULTILINE)
              code = re.sub(r'/\*.*?\*/', '', code, flags=re.DOTALL)
              # Remove espa√ßos extras
              code = re.sub(r'\s+', ' ', code)
              # Lowercase
              code = code.lower()
              return code.strip()
          
          def calculate_similarity(code1, code2):
              """Calcula similaridade entre dois c√≥digos"""
              norm1 = normalize_code(code1)
              norm2 = normalize_code(code2)
              
              if not norm1 or not norm2:
                  return 0
              
              matcher = difflib.SequenceMatcher(None, norm1, norm2)
              return matcher.ratio() * 100
          
          # Buscar todos arquivos de exerc√≠cios submetidos
          exercicios_dir = Path('exercicios')
          submissions = {}
          
          for aula_dir in exercicios_dir.glob('aula*/'):
              aula_num = aula_dir.name
              for file_type in ['index.html', 'script.js', 'style.css']:
                  file_path = aula_dir / file_type
                  if file_path.exists():
                      key = f"{aula_num}/{file_type}"
                      with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                          submissions[key] = f.read()
          
          # Comparar com submiss√µes anteriores (simulado - em produ√ß√£o, buscar de PRs anteriores)
          suspicious = []
          THRESHOLD = 85  # 85% de similaridade = suspeito
          
          # Aqui voc√™ implementaria compara√ß√£o com PRs anteriores
          # Por ora, apenas detecta se c√≥digo ainda est√° muito parecido com template
          
          for key, code in submissions.items():
              # Verifica se ainda tem muitos TODOs
              todo_count = code.count('TODO')
              comment_count = code.count('Implemente')
              
              if todo_count > 5 or comment_count > 5:
                  suspicious.append({
                      'file': key,
                      'reason': f'C√≥digo n√£o implementado ({todo_count} TODOs, {comment_count} coment√°rios)'
                  })
          
          if suspicious:
              print("‚ö†Ô∏è ATEN√á√ÉO: C√≥digo suspeito detectado")
              for item in suspicious:
                  print(f"  - {item['file']}: {item['reason']}")
              
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"suspicious=true\n")
                  f.write(f"count={len(suspicious)}\n")
          else:
              print("‚úÖ Nenhuma suspeita de pl√°gio")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"suspicious=false\n")
          PYTHON_SCRIPT
      
      - name: Comentar suspeita de pl√°gio
        if: steps.plagiarism-check.outputs.suspicious == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const body = `## ‚ö†Ô∏è Alerta de Similaridade de C√≥digo
            
            Nosso sistema detectou que parte do seu c√≥digo ainda est√° muito similar ao template fornecido.
            
            ### üîç O que verificamos:
            - Quantidade de TODOs n√£o removidos
            - C√≥digo ainda comentado
            - Similaridade com template original
            
            ### ‚úÖ O que fazer:
            1. Implemente o c√≥digo completamente
            2. Remova os coment√°rios TODO
            3. Personalize sua solu√ß√£o
            4. N√£o copie c√≥digo de colegas
            
            ### ‚ö†Ô∏è Lembre-se:
            - Copiar c√≥digo √© **viola√ß√£o acad√™mica**
            - Voc√™ pode pesquisar e aprender, mas deve escrever seu pr√≥prio c√≥digo
            - D√∫vidas? Abra uma Issue ou pergunte ao professor
            
            _Este √© um alerta autom√°tico. Se voc√™ acredita que √© um falso positivo, entre em contato com o professor._`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
            
            // Adicionar label de aten√ß√£o
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['‚ö†Ô∏è revisar-manualmente']
            });
