name: Validar Exerc√≠cio - Aula 01

on:
  pull_request:
    paths:
      - 'exercicios/aula01/**'
  push:
    branches:
      - main
    paths:
      - 'exercicios/aula01/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Validar HTML (W3C)
        id: validate-html
        run: |
          echo "üìù Validando HTML..."
          npx html-validate exercicios/aula01/index.html || echo "html_errors=true" >> $GITHUB_OUTPUT
      
      - name: Verificar estrutura HTML
        id: check-structure
        run: |
          echo "üîç Verificando estrutura HTML..."
          FILE="exercicios/aula01/index.html"
          SCORE=0
          ERRORS=""
          
          # DOCTYPE
          if grep -q "<!DOCTYPE html>" "$FILE"; then
            echo "‚úÖ DOCTYPE correto"
            SCORE=$((SCORE + 5))
          else
            echo "‚ùå DOCTYPE ausente ou incorreto"
            ERRORS="${ERRORS}\n- Falta DOCTYPE html"
          fi
          
          # Lang
          if grep -q 'lang="pt-BR"' "$FILE"; then
            echo "‚úÖ Lang pt-BR presente"
            SCORE=$((SCORE + 5))
          else
            echo "‚ùå Atributo lang ausente"
            ERRORS="${ERRORS}\n- Falta lang=\"pt-BR\" na tag <html>"
          fi
          
          # Meta charset
          if grep -q '<meta charset="UTF-8">' "$FILE"; then
            echo "‚úÖ Meta charset presente"
            SCORE=$((SCORE + 5))
          else
            echo "‚ùå Meta charset ausente"
            ERRORS="${ERRORS}\n- Falta <meta charset=\"UTF-8\">"
          fi
          
          # Meta viewport
          if grep -q 'name="viewport"' "$FILE"; then
            echo "‚úÖ Meta viewport presente"
            SCORE=$((SCORE + 5))
          else
            echo "‚ùå Meta viewport ausente"
            ERRORS="${ERRORS}\n- Falta meta viewport para responsividade"
          fi
          
          # Title
          if grep -q '<title>' "$FILE" && ! grep -q '<title>Seu Nome' "$FILE"; then
            echo "‚úÖ Title personalizado"
            SCORE=$((SCORE + 5))
          else
            echo "‚ùå Title n√£o personalizado"
            ERRORS="${ERRORS}\n- Personalize o <title>"
          fi
          
          # Tags sem√¢nticas
          for tag in header main section footer; do
            if grep -q "<$tag>" "$FILE"; then
              echo "‚úÖ Tag <$tag> presente"
              SCORE=$((SCORE + 5))
            else
              echo "‚ùå Tag <$tag> ausente"
              ERRORS="${ERRORS}\n- Falta tag <$tag>"
            fi
          done
          
          # Headings hierarchy
          if grep -q '<h1>' "$FILE" && grep -q '<h2>' "$FILE"; then
            echo "‚úÖ Hierarquia de headings presente"
            SCORE=$((SCORE + 5))
          else
            echo "‚ùå Falta hierarquia de headings"
            ERRORS="${ERRORS}\n- Use h1, h2, h3 corretamente"
          fi
          
          # Imagem com alt
          if grep -q 'alt=' "$FILE" && ! grep -q 'alt="\[Seu Nome\]"' "$FILE"; then
            echo "‚úÖ Imagem com alt personalizado"
            SCORE=$((SCORE + 5))
          else
            echo "‚ùå Alt da imagem n√£o personalizado"
            ERRORS="${ERRORS}\n- Personalize o atributo alt da imagem"
          fi
          
          # Listas
          if grep -q '<ul>' "$FILE" && grep -q '<ol>' "$FILE"; then
            echo "‚úÖ Listas (ul e ol) presentes"
            SCORE=$((SCORE + 10))
          else
            echo "‚ùå Faltam listas"
            ERRORS="${ERRORS}\n- Adicione listas <ul> e <ol>"
          fi
          
          # Tabela
          if grep -q '<table>' "$FILE" && grep -q '<thead>' "$FILE" && grep -q '<tbody>' "$FILE"; then
            echo "‚úÖ Tabela completa"
            SCORE=$((SCORE + 10))
          else
            echo "‚ùå Tabela incompleta"
            ERRORS="${ERRORS}\n- Adicione tabela com thead e tbody"
          fi
          
          # Links
          if grep -q '<a href=' "$FILE"; then
            echo "‚úÖ Links presentes"
            SCORE=$((SCORE + 5))
          else
            echo "‚ùå Faltam links"
            ERRORS="${ERRORS}\n- Adicione links de contato"
          fi
          
          # Conte√∫do personalizado
          if ! grep -q 'Seu Nome Completo' "$FILE" && ! grep -q 'seuemail@example.com' "$FILE"; then
            echo "‚úÖ Conte√∫do personalizado"
            SCORE=$((SCORE + 20))
          else
            echo "‚ùå Conte√∫do n√£o personalizado"
            ERRORS="${ERRORS}\n- Substitua os placeholders pelo seu conte√∫do"
          fi
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "errors<<EOF" >> $GITHUB_OUTPUT
          echo -e "$ERRORS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo ""
          echo "üìä SCORE: $SCORE/100"
      
      - name: Comentar no PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const score = '${{ steps.check-structure.outputs.score }}';
            const errors = `${{ steps.check-structure.outputs.errors }}`;
            
            let emoji = '‚≠ê';
            let level = 'Regular';
            if (score >= 90) {
              emoji = '‚≠ê‚≠ê‚≠ê';
              level = 'Excelente';
            } else if (score >= 70) {
              emoji = '‚≠ê‚≠ê';
              level = 'Bom';
            } else if (score >= 50) {
              emoji = '‚≠ê';
              level = 'Regular';
            } else {
              emoji = '‚ùå';
              level = 'Precisa melhorar';
            }
            
            const body = `## ü§ñ Valida√ß√£o Autom√°tica - Aula 01
            
            ### üìä Resultado: ${score}/100 ${emoji}
            **N√≠vel:** ${level}
            
            ${errors ? '### ‚ùå Problemas Encontrados:\n' + errors : '### ‚úÖ Todos os requisitos atendidos!'}
            
            ${score >= 70 ? 'üéâ √ìtimo trabalho! Seu exerc√≠cio est√° aprovado.' : 'üìù Corrija os problemas acima e fa√ßa um novo push. O bot validar√° automaticamente.'}
            
            ---
            
            ### üí° Dicas:
            - Valide seu HTML em: https://validator.w3.org/#validate_by_input
            - Use o DevTools (F12) para inspecionar seu c√≥digo
            - Consulte os slides da Aula 1 se tiver d√∫vidas
            
            ### üìö Recursos:
            - [MDN - HTML B√°sico](https://developer.mozilla.org/pt-BR/docs/Learn/Getting_started_with_the_web/HTML_basics)
            - [W3Schools - HTML](https://www.w3schools.com/html/)
            
            _Valida√ß√£o executada em: ${new Date().toLocaleString('pt-BR')}_`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      
      - name: Definir status do check
        if: steps.check-structure.outputs.score < 70
        run: |
          echo "‚ùå Score abaixo de 70. PR precisa de melhorias."
          exit 1
