name: Atualizar Ranking

on:
  schedule:
    - cron: '0 0 * * 1'  # Toda segunda 00:00 UTC
  workflow_dispatch:  # Permite execu√ß√£o manual

jobs:
  update-ranking:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Coletar dados dos PRs
        id: collect-data
        uses: actions/github-script@v6
        with:
          script: |
            // Buscar todos PRs merged
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              per_page: 100
            });
            
            const mergedPRs = prs.filter(pr => pr.merged_at);
            
            // Extrair scores dos coment√°rios do bot
            const students = {};
            
            for (const pr of mergedPRs) {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number
              });
              
              // Buscar coment√°rio do bot com score
              const botComment = comments.find(c => 
                c.user.login === 'github-actions[bot]' && 
                c.body.includes('Valida√ß√£o Autom√°tica')
              );
              
              if (botComment) {
                const scoreMatch = botComment.body.match(/Resultado: (\d+)\/100/);
                if (scoreMatch) {
                  const score = parseInt(scoreMatch[1]);
                  const titleMatch = pr.title.match(/\[Aula (\d+)\]\s*(.+)/);
                  
                  if (titleMatch) {
                    const aula = titleMatch[1];
                    const nome = titleMatch[2].trim();
                    
                    if (!students[nome]) {
                      students[nome] = {
                        name: nome,
                        scores: {},
                        totalScore: 0,
                        exercisesCompleted: 0,
                        username: pr.user.login,
                        avatar: pr.user.avatar_url
                      };
                    }
                    
                    students[nome].scores[`aula${aula}`] = score;
                    students[nome].totalScore += score;
                    students[nome].exercisesCompleted++;
                  }
                }
              }
            }
            
            // Calcular m√©dia e ordenar
            const ranking = Object.values(students).map(student => ({
              ...student,
              avgScore: student.exercisesCompleted > 0 
                ? (student.totalScore / student.exercisesCompleted).toFixed(1)
                : 0
            })).sort((a, b) => parseFloat(b.avgScore) - parseFloat(a.avgScore));
            
            // Salvar em arquivo
            const fs = require('fs');
            fs.writeFileSync('ranking-data.json', JSON.stringify(ranking, null, 2));
            
            return { count: ranking.length };
      
      - name: Gerar README com Ranking
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          from datetime import datetime
          
          with open('ranking-data.json', 'r') as f:
              ranking = json.load(f)
          
          medals = ['ü•á', 'ü•à', 'ü•â']
          
          readme = f"""# üèÜ Ranking de Alunos - DevOps Tools 2026.1
          
          **Atualizado em:** {datetime.now().strftime('%d/%m/%Y %H:%M')} UTC
          
          ## üìä Top 20 Alunos
          
          | Posi√ß√£o | Aluno | Exerc√≠cios | M√©dia | Pontua√ß√£o Total |
          |---------|-------|------------|-------|-----------------|
          """
          
          for i, student in enumerate(ranking[:20], 1):
              medal = medals[i-1] if i <= 3 else f"{i}Ô∏è‚É£"
              name = student['name']
              exercises = student['exercisesCompleted']
              avg = student['avgScore']
              total = student['totalScore']
              
              readme += f"| {medal} | {name} | {exercises} | {avg} | {total} |\n"
          
          readme += f"""
          
          ## üìà Estat√≠sticas Gerais
          
          - **Total de alunos:** {len(ranking)}
          - **Exerc√≠cios submetidos:** {sum(s['exercisesCompleted'] for s in ranking)}
          - **M√©dia geral da turma:** {sum(float(s['avgScore']) for s in ranking) / len(ranking):.1f}
          
          ## üéñÔ∏è Badges de Conquistas
          
          ### ‚≠ê Excel√™ncia (M√©dia ‚â• 90)
          """
          
          excelentes = [s['name'] for s in ranking if float(s['avgScore']) >= 90]
          if excelentes:
              readme += '\n' + ', '.join(excelentes) + '\n'
          else:
              readme += '\n_Nenhum aluno ainda_\n'
          
          readme += """
          ### üí™ Dedica√ß√£o (10+ exerc√≠cios)
          """
          
          dedicados = [s['name'] for s in ranking if s['exercisesCompleted'] >= 10]
          if dedicados:
              readme += '\n' + ', '.join(dedicados) + '\n'
          else:
              readme += '\n_Nenhum aluno ainda_\n'
          
          readme += """
          ### üöÄ Primeira Entrega (Primeiro a submeter cada aula)
          
          _Em desenvolvimento_
          
          ---
          
          ## üìù Como Melhorar Sua Posi√ß√£o
          
          1. **Complete mais exerc√≠cios** - Cada aula vale 100 pontos
          2. **Capriche no c√≥digo** - Boas pr√°ticas aumentam sua nota
          3. **Seja criativo** - B√¥nus para solu√ß√µes diferenciadas
          4. **Entregue no prazo** - Penaliza√ß√£o por atraso
          5. **Ajude colegas** - Abra Issues, responda d√∫vidas
          
          ---
          
          _Ranking atualizado automaticamente toda segunda-feira._
          """
          
          with open('RANKING.md', 'w') as f:
              f.write(readme)
          
          print("‚úÖ Ranking gerado com sucesso!")
          PYTHON_SCRIPT
      
      - name: Commit e Push
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add RANKING.md ranking-data.json
          git diff --quiet && git diff --staged --quiet || git commit -m "chore: atualizar ranking autom√°tico"
          git push
