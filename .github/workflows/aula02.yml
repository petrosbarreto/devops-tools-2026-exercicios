name: Validar Exerc√≠cio - Aula 02

on:
  pull_request:
    paths:
      - 'exercicios/aula02/**'
  push:
    branches:
      - main
    paths:
      - 'exercicios/aula02/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Instalar depend√™ncias
        run: npm install html-validate eslint
      
      - name: Validar arquivos existem
        id: check-files
        run: |
          SCORE=0
          ERRORS=""
          
          if [ -f "exercicios/aula02/index.html" ]; then
            echo "‚úÖ index.html existe"
            SCORE=$((SCORE + 10))
          else
            echo "‚ùå index.html n√£o encontrado"
            ERRORS="${ERRORS}\n- Falta arquivo index.html"
          fi
          
          if [ -f "exercicios/aula02/style.css" ]; then
            echo "‚úÖ style.css existe"
            SCORE=$((SCORE + 10))
          else
            echo "‚ùå style.css n√£o encontrado"
            ERRORS="${ERRORS}\n- Falta arquivo style.css"
          fi
          
          if [ -f "exercicios/aula02/script.js" ]; then
            echo "‚úÖ script.js existe"
            SCORE=$((SCORE + 10))
          else
            echo "‚ùå script.js n√£o encontrado"
            ERRORS="${ERRORS}\n- Falta arquivo script.js"
          fi
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "errors<<EOF" >> $GITHUB_OUTPUT
          echo -e "$ERRORS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Validar HTML
        id: validate-html
        run: |
          FILE="exercicios/aula02/index.html"
          SCORE=0
          ERRORS=""
          
          # Link CSS externo
          if grep -q '<link rel="stylesheet"' "$FILE"; then
            echo "‚úÖ CSS externo linkado"
            SCORE=$((SCORE + 5))
          else
            ERRORS="${ERRORS}\n- CSS n√£o est√° linkado externamente"
          fi
          
          # Script JS externo
          if grep -q '<script src=' "$FILE"; then
            echo "‚úÖ JavaScript externo linkado"
            SCORE=$((SCORE + 5))
          else
            ERRORS="${ERRORS}\n- JavaScript n√£o est√° linkado externamente"
          fi
          
          # Bot√£o carregar
          if grep -q 'btn-carregar' "$FILE"; then
            echo "‚úÖ Bot√£o carregar presente"
            SCORE=$((SCORE + 5))
          else
            ERRORS="${ERRORS}\n- Falta bot√£o de carregar usu√°rios"
          fi
          
          # Formul√°rio
          if grep -q '<form' "$FILE"; then
            echo "‚úÖ Formul√°rio presente"
            SCORE=$((SCORE + 5))
          else
            ERRORS="${ERRORS}\n- Falta formul√°rio"
          fi
          
          # √Årea de resultados
          if grep -q 'usuarios-container' "$FILE"; then
            echo "‚úÖ Container de usu√°rios presente"
            SCORE=$((SCORE + 5))
          else
            ERRORS="${ERRORS}\n- Falta div para exibir usu√°rios"
          fi
          
          # Info requisi√ß√£o
          if grep -q 'info-metodo' "$FILE" && grep -q 'info-status' "$FILE"; then
            echo "‚úÖ √Årea de informa√ß√µes presente"
            SCORE=$((SCORE + 5))
          else
            ERRORS="${ERRORS}\n- Falta √°rea para exibir info da requisi√ß√£o"
          fi
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "errors<<EOF" >> $GITHUB_OUTPUT
          echo -e "$ERRORS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Validar JavaScript
        id: validate-js
        run: |
          FILE="exercicios/aula02/script.js"
          SCORE=0
          ERRORS=""
          
          # Fetch usado
          if grep -q 'fetch(' "$FILE"; then
            echo "‚úÖ Fetch API usado"
            SCORE=$((SCORE + 10))
          else
            echo "‚ùå Fetch API n√£o encontrado"
            ERRORS="${ERRORS}\n- Use fetch() para requisi√ß√µes HTTP"
          fi
          
          # Async/await
          if grep -q 'async' "$FILE" && grep -q 'await' "$FILE"; then
            echo "‚úÖ Async/await implementado"
            SCORE=$((SCORE + 10))
          else
            ERRORS="${ERRORS}\n- Use async/await nas fun√ß√µes"
          fi
          
          # Try/catch
          if grep -q 'try {' "$FILE" && grep -q 'catch' "$FILE"; then
            echo "‚úÖ Tratamento de erros implementado"
            SCORE=$((SCORE + 10))
          else
            ERRORS="${ERRORS}\n- Adicione try/catch para tratar erros"
          fi
          
          # Fun√ß√£o carregarUsuarios
          if grep -q 'function carregarUsuarios' "$FILE" || grep -q 'carregarUsuarios.*=' "$FILE"; then
            echo "‚úÖ Fun√ß√£o carregarUsuarios existe"
            SCORE=$((SCORE + 5))
          else
            ERRORS="${ERRORS}\n- Implemente fun√ß√£o carregarUsuarios()"
          fi
          
          # Fun√ß√£o criarPost
          if grep -q 'function criarPost' "$FILE" || grep -q 'criarPost.*=' "$FILE"; then
            echo "‚úÖ Fun√ß√£o criarPost existe"
            SCORE=$((SCORE + 5))
          else
            ERRORS="${ERRORS}\n- Implemente fun√ß√£o criarPost()"
          fi
          
          # Event listeners
          if grep -q 'addEventListener' "$FILE"; then
            echo "‚úÖ Event listeners adicionados"
            SCORE=$((SCORE + 5))
          else
            ERRORS="${ERRORS}\n- Adicione event listeners"
          fi
          
          # Manipula√ß√£o DOM
          if grep -q 'getElementById' "$FILE" || grep -q 'querySelector' "$FILE"; then
            echo "‚úÖ Manipula√ß√£o DOM presente"
            SCORE=$((SCORE + 5))
          else
            ERRORS="${ERRORS}\n- Use m√©todos de sele√ß√£o DOM"
          fi
          
          # Status code exibido
          if grep -q 'status' "$FILE"; then
            echo "‚úÖ Status code tratado"
            SCORE=$((SCORE + 5))
          else
            ERRORS="${ERRORS}\n- Exiba o status code da resposta"
          fi
          
          # C√≥digo n√£o est√° s√≥ comentado
          TODO_COUNT=$(grep -c 'TODO' "$FILE" || echo "0")
          if [ "$TODO_COUNT" -lt 5 ]; then
            echo "‚úÖ C√≥digo implementado (poucos TODOs)"
            SCORE=$((SCORE + 10))
          else
            ERRORS="${ERRORS}\n- Implemente o c√≥digo (muitos TODOs restantes)"
          fi
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "errors<<EOF" >> $GITHUB_OUTPUT
          echo -e "$ERRORS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Validar CSS
        id: validate-css
        run: |
          FILE="exercicios/aula02/style.css"
          SCORE=0
          
          # Arquivo n√£o vazio
          if [ -s "$FILE" ]; then
            echo "‚úÖ CSS n√£o est√° vazio"
            SCORE=$((SCORE + 5))
          fi
          
          # Cards ou layout
          if grep -q '.user-card' "$FILE" || grep -q 'grid' "$FILE"; then
            echo "‚úÖ Layout de cards implementado"
            SCORE=$((SCORE + 5))
          fi
          
          # Responsividade
          if grep -q '@media' "$FILE"; then
            echo "‚úÖ Media queries presentes"
            SCORE=$((SCORE + 5))
          fi
          
          # Loading
          if grep -q '.hidden' "$FILE" || grep -q '#loading' "$FILE"; then
            echo "‚úÖ Estilo de loading presente"
            SCORE=$((SCORE + 5))
          fi
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
      
      - name: Calcular score total
        id: calc-score
        run: |
          FILE_SCORE=${{ steps.check-files.outputs.score }}
          HTML_SCORE=${{ steps.validate-html.outputs.score }}
          JS_SCORE=${{ steps.validate-js.outputs.score }}
          CSS_SCORE=${{ steps.validate-css.outputs.score }}
          
          TOTAL=$((FILE_SCORE + HTML_SCORE + JS_SCORE + CSS_SCORE))
          
          echo "üìä Pontua√ß√£o:"
          echo "  Arquivos: $FILE_SCORE/30"
          echo "  HTML: $HTML_SCORE/30"
          echo "  JavaScript: $JS_SCORE/65"
          echo "  CSS: $CSS_SCORE/20"
          echo "  TOTAL: $TOTAL/145"
          
          # Normalizar para 100
          NORMALIZED=$((TOTAL * 100 / 145))
          
          echo "score=$NORMALIZED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
      
      - name: Comentar no PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const score = parseInt('${{ steps.calc-score.outputs.score }}');
            const fileErrors = `${{ steps.check-files.outputs.errors }}`;
            const htmlErrors = `${{ steps.validate-html.outputs.errors }}`;
            const jsErrors = `${{ steps.validate-js.outputs.errors }}`;
            
            let emoji = '‚≠ê';
            let level = 'Regular';
            if (score >= 90) {
              emoji = '‚≠ê‚≠ê‚≠ê';
              level = 'Excelente';
            } else if (score >= 70) {
              emoji = '‚≠ê‚≠ê';
              level = 'Bom';
            } else if (score >= 50) {
              emoji = '‚≠ê';
              level = 'Regular';
            } else {
              emoji = '‚ùå';
              level = 'Precisa melhorar';
            }
            
            const allErrors = [fileErrors, htmlErrors, jsErrors].filter(e => e.trim()).join('\n');
            
            const body = `## ü§ñ Valida√ß√£o Autom√°tica - Aula 02
            
            ### üìä Resultado: ${score}/100 ${emoji}
            **N√≠vel:** ${level}
            
            **Detalhamento:**
            - üìÅ Estrutura de arquivos: ${{ steps.check-files.outputs.score }}/30
            - üìù HTML: ${{ steps.validate-html.outputs.score }}/30
            - üíª JavaScript: ${{ steps.validate-js.outputs.score }}/65
            - üé® CSS: ${{ steps.validate-css.outputs.score }}/20
            
            ${allErrors ? '### ‚ùå Problemas Encontrados:\n' + allErrors : '### ‚úÖ Todos os requisitos atendidos!'}
            
            ${score >= 70 ? 'üéâ √ìtimo trabalho! Seu exerc√≠cio est√° aprovado.' : 'üìù Corrija os problemas acima e fa√ßa um novo push.'}
            
            ---
            
            ### üí° Dicas:
            - Teste sua aplica√ß√£o no navegador (abra index.html)
            - Use DevTools Console (F12) para ver erros JavaScript
            - Verifique se fetch() est√° funcionando
            - Confirme que usu√°rios aparecem na tela ao clicar no bot√£o
            
            ### üìö Recursos:
            - [JSONPlaceholder API](https://jsonplaceholder.typicode.com/)
            - [MDN - Fetch API](https://developer.mozilla.org/pt-BR/docs/Web/API/Fetch_API)
            - [Slides da Aula 2](../../slides/aula02/)
            
            _Valida√ß√£o executada em: ${new Date().toLocaleString('pt-BR')}_`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      
      - name: Definir status do check
        if: steps.calc-score.outputs.score < 70
        run: |
          echo "‚ùå Score abaixo de 70. PR precisa de melhorias."
          exit 1
